<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·∫øt Nguy√™n ƒê√°n 2026 - Galaxy Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- C·∫§U H√åNH CHUNG --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #000;
            color: white;
            overflow: hidden; 
            min-height: 100vh;
            font-family: 'Montserrat', sans-serif;
            user-select: none; -webkit-user-select: none;
        }

        /* --- 1. ƒê·∫æM NG∆Ø·ª¢C --- */
        #countdown-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 1.5s ease;
        }
        #countdown {
            font-size: 18vw; 
            font-weight: 900; font-family: 'Playfair Display', serif;
            background: radial-gradient(ellipse at center, #FFFFC2 0%, #FFD700 40%, #FDB931 70%, #9B7500 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.6));
            animation: pulseCount 1s infinite alternate;
        }
        .countdown-subtext {
            font-size: 5vw; 
            color: #FFA500; margin-top: 20px; letter-spacing: 1px;
            font-family: 'Dancing Script', cursive; text-align: center;
        }
        @keyframes pulseCount {
            0% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.7)); }
            100% { transform: scale(1.1); filter: drop-shadow(0 0 50px rgba(255, 215, 0, 1)); }
        }

        /* --- 2. SLIDESHOW --- */
        #slideshow-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
            z-index: 1000; justify-content: center; align-items: center; flex-direction: column;
        }
        .slide-image-container {
            position: relative; width: 90%; max-width: 600px; height: 60vh;
            display: flex; justify-content: center; align-items: center;
        }
        .slide-img {
            max-width: 100%; max-height: 100%; border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); border: 2px solid #FFD700;
            opacity: 0; position: absolute; transition: all 1.5s ease-in-out; transform: scale(0.9);
        }
        .slide-img.active { opacity: 1; transform: scale(1); }
        .slide-caption {
            margin-top: 20px; font-size: 1.8rem; color: #FFD700; text-align: center;
            font-family: 'Dancing Script', cursive; opacity: 0; transition: opacity 1s ease;
        }

        /* --- 3. M√ÄN H√åNH FINAL (N√ÇNG C·∫§P GALAXY) --- */
        #final-screen {
            display: none; width: 100%; height: 100vh;
            /* N·ªÅn Galaxy s√¢u th·∫≥m */
            background: radial-gradient(circle at center, #4a0000 0%, #1a0000 40%, #050505 100%);
            position: relative; overflow: hidden; z-index: 10;
        }

        /* Th√™m c√°c ng√¥i sao l·∫•p l√°nh n·ªÅn */
        #final-screen::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            animation: starMove 100s linear infinite;
            opacity: 0.6; z-index: 1;
        }
        @keyframes starMove { from { transform: translateY(0); } to { transform: translateY(-1000px); } }

        /* V√≤ng h√†o quang ph√≠a sau l√¨ x√¨ */
        .halo-ring {
            position: absolute; top: 50%; left: 50%;
            width: 320px; height: 320px; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc v·ª´a ph·∫£i tr√™n mobile */
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            animation: rotateHalo 30s linear infinite;
            pointer-events: none; z-index: 15; /* N·∫±m d∆∞·ªõi l√¨ x√¨ nh∆∞ng tr√™n n·ªÅn */
        }
        .halo-ring::after {
            content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%);
            width: 16px; height: 16px; background: #FFD700; border-radius: 50%;
            box-shadow: 0 0 20px #FFD700;
        }
        @keyframes rotateHalo { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        #center-stage {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 0; height: 0; 
            z-index: 20; /* L√¨ x√¨ ·ªü gi·ªØa */
            display: flex; justify-content: center; align-items: center;
        }

        /* Phong th∆∞ l√¨ x√¨ */
        #final-envelope-container {
            position: absolute; z-index: 20;
            width: 200px; height: 300px; /* K√≠ch th∆∞·ªõc chu·∫©n */
            perspective: 1000px;
            opacity: 0; transform: scale(0); transition: all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #final-envelope-container.show { opacity: 1; transform: scale(1); }

        #final-envelope {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #d4af37 0%, #f7ef8a 100%);
            border-radius: 15px; position: relative;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); /* Glow m·∫°nh h∆°n */
            cursor: pointer; transition: transform 0.5s; transform-style: preserve-3d;
        }
        #final-envelope:active { transform: scale(0.95); } 

        .envelope-flap {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(135deg, #b8860b 0%, #d4af37 100%);
            clip-path: polygon(0 0, 100% 0, 50% 100%);
            transform-origin: top; transition: transform 0.6s ease-in-out; z-index: 5;
        }
        #final-envelope.open .envelope-flap { transform: rotateX(180deg); z-index: 1; }

        .envelope-body {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2;
        }
        .envelope-icon { font-size: 4rem; animation: floatIcon 2s infinite ease-in-out; }
        @keyframes floatIcon { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .envelope-text { font-family: 'Dancing Script', cursive; color: #8B0000; font-size: 1.5rem; font-weight: bold; margin-top: 10px; }

        /* ·∫¢nh v·ªá tinh (Style Khung Tranh Bay L∆° L·ª≠ng 2.5D) */
        .satellite-item {
            position: absolute; 
            border-radius: 12px; 
            overflow: hidden; 
            border: 2px solid rgba(255, 215, 0, 0.8);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            opacity: 0; 
            transition: box-shadow 0.3s;
            cursor: pointer;
            will-change: transform, opacity, z-index; 
        }
        .satellite-item img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Hi·ªáu ·ª©ng khi b·∫•m v√†o ·∫£nh */
        .satellite-item.highlight {
            box-shadow: 0 0 30px #FFD700, 0 0 60px #FF4500 !important;
            border-color: #fff !important;
            z-index: 100 !important;
        }

        .final-title-text {
            position: absolute; top: 10%; width: 100%; text-align: center;
            font-size: 2.8rem; 
            font-family: 'Playfair Display', serif;
            background: linear-gradient(to right, #FFD700, #FFFACD, #DAA520);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
            z-index: 30; opacity: 0; animation: fadeIn 2s forwards 1s;
            letter-spacing: 2px;
            padding: 0 10px;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        /* --- 4. MODAL L√å X√å --- */
        #red-envelope-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.92); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(10px); perspective: 1500px;
            padding: 20px;
        }

        .god-rays {
            position: absolute; width: 200vw; height: 200vw;
            background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0.1) 0deg 10deg, transparent 10deg 20deg);
            animation: rotateRays 25s linear infinite; z-index: -1; pointer-events: none;
        }
        @keyframes rotateRays { to { transform: rotate(360deg); } }

        .luxury-card {
            background: linear-gradient(160deg, #8B0000 0%, #B22222 50%, #800000 100%);
            width: 100%; max-width: 400px; padding: 3px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.3);
            animation: openCard 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }
        @keyframes openCard { 0% { transform: scale(0.6); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .luxury-inner {
            background: linear-gradient(to bottom, #990000, #660000);
            border-radius: 17px; padding: 30px 20px;
            display: flex; flex-direction: column; align-items: center;
            border: 2px solid rgba(255, 215, 0, 0.3); position: relative; overflow: hidden;
        }

        .luxury-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            border: 3px solid #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            padding: 2px; background: #FFD700; margin-bottom: 15px;
        }
        .luxury-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

        .gold-text {
            font-family: 'Dancing Script', cursive; font-size: 2.2rem;
            background: linear-gradient(to bottom, #FFD700, #FFFACD, #DAA520);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5)); margin-bottom: 8px; text-align: center;
        }

        .wishes-text {
            color: #fff; font-size: 1rem; line-height: 1.5; text-align: center; margin-bottom: 20px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-weight: 500;
        }

        .qr-frame {
            padding: 8px; background: rgba(255,255,255,0.1);
            border: 2px solid #FFD700; border-radius: 10px; margin-bottom: 20px;
        }
        .qr-frame img { display: block; border-radius: 5px; width: 130px; height: 130px; }

        .royal-btn {
            background: linear-gradient(to right, #DAA520, #FFD700, #DAA520);
            color: #800000; font-weight: 800; border: none; width: 100%;
            padding: 15px 0; border-radius: 50px; cursor: pointer;
            font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
        }
        .royal-btn:active { transform: scale(0.98); }

        /* H·ªÜ TH·ªêNG H·∫†T */
        .particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .burst-particle { position: absolute; border-radius: 50%; pointer-events: none; }
        
        /* M∆∞a v√†ng modal */
        .gold-dust {
            position: absolute; width: 4px; height: 4px; background: #FFD700; border-radius: 50%;
            animation: fall 3s linear forwards; pointer-events: none;
        }
        @keyframes fall { to { transform: translateY(600px); } }

        /* NH·∫†C */
        .music-btn {
            position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px;
            border-radius: 50%; background: rgba(255, 215, 0, 0.8); border: 2px solid #FFD700; 
            cursor: pointer; z-index: 5000;
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: #b30000;
            animation: spin 5s linear infinite; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            touch-action: manipulation; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="no-scroll">
    <div class="particle-container" id="global-particles"></div>

    <div id="countdown-screen">
        <div id="countdown">10</div>
        <div class="countdown-subtext">ƒê·∫øm ng∆∞·ª£c ch√†o nƒÉm m·ªõi...</div>
    </div>

    <div id="slideshow-screen">
        <div class="slide-image-container" id="slide-container"></div>
        <div class="slide-caption" id="slide-caption"></div>
    </div>

    <div id="final-screen">
        <h1 class="final-title-text">Xu√¢n Nh∆∞ √ù 2026</h1>
        
        <div class="halo-ring"></div> 

        <div id="center-stage">
            <div id="final-envelope-container">
                <div id="final-envelope">
                    <div class="envelope-flap"></div>
                    <div class="envelope-body">
                        <div class="envelope-icon">üßß</div>
                        <div class="envelope-text">L√¨ X√¨ ƒê·∫°i C√°t</div>
                        <div style="color: #8B0000; margin-top: 5px; font-size: 0.9rem; animation: blink 2s infinite;">(Nh·∫•n ƒë·ªÉ m·ªü)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="red-envelope-screen">
        <div class="god-rays"></div>
        <div id="modal-particles" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow: hidden;"></div>
        
        <div class="luxury-card">
            <div class="luxury-inner">
                <div class="luxury-avatar">
                    <img src="https://i.pinimg.com/736x/a7/b6/67/a7b667b0da309a125fc167d1463a3d98.jpg" alt="Th·∫ßn T√†i">
                </div>
                <h2 class="gold-text">T·∫•n T√†i T·∫•n L·ªôc</h2>
                <p class="wishes-text">
                    Ch√†o ƒê·∫°t Dz! NƒÉm m·ªõi 2026 ch√∫c anh code th√¨ √≠t bug, ti·ªÅn v·ªÅ nh∆∞ n∆∞·ªõc, h·ªçc tr√≤ ngoan gi·ªèi, v·∫°n s·ª± nh∆∞ m∆°!
                </p>
                <div class="qr-frame">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=ChucMungNamMoi_DatDz_2026" alt="QR Code">
                </div>
                <button class="royal-btn" onclick="closeModal()">Nh·∫≠n L·ªôc Ngay</button>
            </div>
        </div>
    </div>

    <button class="music-btn" id="music-toggle"><i class="fas fa-music"></i></button>
    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-vietnamese-tet-holiday-120.mp3" type="audio/mpeg">
    </audio>
    <audio id="open-sound" src="https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3"></audio>
    <audio id="burst-sound" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <script>
        /* --- D·ªÆ LI·ªÜU ·∫¢NH (C√≥ th·ªÉ thay th·∫ø) --- */
        const images = [
            { url: 'https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=600', caption: 'Gia ƒë√¨nh' },
            { url: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=600', caption: 'M·∫π y√™u' },
            { url: 'https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?w=600', caption: 'T·∫•t ni√™n' },
            { url: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=600', caption: 'Vui v·∫ª' },
            { url: 'https://images.unsplash.com/photo-1540331547168-8b63109225b7?w=600', caption: 'Du xu√¢n' },
            { url: 'https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=600', caption: 'K·ª∑ ni·ªám' },
            { url: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=600', caption: 'H·∫°nh ph√∫c' },
            { url: 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?w=600', caption: 'Th√†nh c√¥ng' }
        ];

        /* --- DETECT MOBILE --- */
        const isMobile = window.innerWidth < 768;

        const countdownEl = document.getElementById('countdown');
        const countdownScreen = document.getElementById('countdown-screen');
        const slideScreen = document.getElementById('slideshow-screen');
        const finalScreen = document.getElementById('final-screen');
        const centerStage = document.getElementById('center-stage');
        const globalParticles = document.getElementById('global-particles');

        let count = 10;
        let fwInterval;

        /* --- 1. LOGIC ƒê·∫æM NG∆Ø·ª¢C --- */
        setTimeout(() => {
            const timer = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                let intensity = (10 - count) * (isMobile ? 1 : 2); 
                spawnManyFireworks(Math.max(2, intensity));

                if (count <= 0) {
                    clearInterval(timer);
                    countdownEl.textContent = "2026";
                    spawnManyFireworks(isMobile ? 20 : 50);
                    setTimeout(() => {
                        countdownScreen.style.opacity = 0;
                        setTimeout(() => {
                            countdownScreen.style.display = 'none';
                            startSlideshow();
                        }, 1000);
                    }, 2000);
                }
            }, 1000);
            fwInterval = setInterval(() => spawnManyFireworks(isMobile ? 1 : 2), 800);
        }, 500);

        /* --- 2. LOGIC SLIDESHOW --- */
        let currentIdx = 0;
        const slideContainer = document.getElementById('slide-container');
        const slideCaption = document.getElementById('slide-caption');

        function startSlideshow() {
            clearInterval(fwInterval);
            slideScreen.style.display = 'flex';
            showNextImage();
        }

        function showNextImage() {
            if (currentIdx >= images.length) {
                setTimeout(showFinalScreen, 1000);
                return;
            }
            const data = images[currentIdx];
            const img = document.createElement('img');
            img.src = data.url; img.className = 'slide-img';
            slideContainer.appendChild(img);

            setTimeout(() => {
                img.classList.add('active');
                slideCaption.textContent = data.caption; slideCaption.style.opacity = 1;
                spawnFireworkBurst(window.innerWidth/2, window.innerHeight/2, isMobile ? 5 : 10, ['#FFD700']);
            }, 100);

            setTimeout(() => {
                img.classList.remove('active'); slideCaption.style.opacity = 0;
                setTimeout(() => { img.remove(); currentIdx++; showNextImage(); }, 1500);
            }, 2500);
        }

        /* --- 3. FINAL SCREEN: 2.5D GALAXY SYSTEM --- */
        function showFinalScreen() {
            slideScreen.style.display = 'none';
            finalScreen.style.display = 'block';

            setTimeout(() => {
                document.getElementById('final-envelope-container').classList.add('show');
            }, 500);

            const total = images.length;
            // B√°n k√≠nh qu·ªπ ƒë·∫°o (Orbit Radius)
            const radiusX = isMobile ? 165 : 350; // R·ªông h∆°n
            const radiusY = isMobile ? 70 : 130;  // D·∫πt h∆°n ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng nghi√™ng
            
            const angleStep = (2 * Math.PI) / total;
            let baseAngle = 0; 
            const satellites = []; 
            
            images.forEach((data, i) => {
                const div = document.createElement('div');
                div.className = 'satellite-item';
                div.innerHTML = `<img src="${data.url}" alt="Ky niem">`;
                
                // K√≠ch th∆∞·ªõc ·∫£nh c∆° b·∫£n
                const size = isMobile ? 80 : 120;
                div.style.width = size + 'px';
                div.style.height = size + 'px';
                div.style.marginLeft = (-size/2) + 'px'; 
                div.style.marginTop = (-size/2) + 'px';

                // S·ª± ki·ªán click ph√≥ng to (Highlight)
                div.addEventListener('click', (e) => {
                     e.stopPropagation();
                     div.classList.toggle('highlight');
                     // N·∫øu highlight th√¨ set transform c·ªë ƒë·ªãnh, n·∫øu kh√¥ng th√¨ ƒë·ªÉ animation loop x·ª≠ l√Ω
                     if(div.classList.contains('highlight')) {
                         div.style.transform = `translate(${parseFloat(div.dataset.x)}px, ${parseFloat(div.dataset.y)}px) scale(2)`;
                     }
                });
                
                centerStage.appendChild(div);
                satellites.push({ el: div, index: i, angleOffset: i * angleStep });
            });

            // V√íNG L·∫∂P ANIMATION (Math Logic)
            function animateSatellites() {
                baseAngle += 0.003; // T·ªëc ƒë·ªô xoay
                
                satellites.forEach(sat => {
                    // N·∫øu ƒëang highlight th√¨ b·ªè qua animation v·ªã tr√≠
                    if (sat.el.classList.contains('highlight')) return;

                    const currentAngle = baseAngle + sat.angleOffset;
                    
                    // Ph∆∞∆°ng tr√¨nh tham s·ªë c·ªßa Ellipse: x = a*cos(t), y = b*sin(t)
                    const x = Math.cos(currentAngle) * radiusX;
                    const y = Math.sin(currentAngle) * radiusY;

                    // Gi·∫£ l·∫≠p ƒë·ªô s√¢u (Depth): Y d∆∞∆°ng (d∆∞·ªõi) l√† g·∫ßn, Y √¢m (tr√™n) l√† xa
                    // Scale factor: Normalize Y t·ª´ [-radiusY, radiusY] -> [0.7, 1.3]
                    const scaleFactor = 1 + (y / radiusY) * 0.3; 
                    
                    // Opacity & Blur theo ƒë·ªô s√¢u
                    const opacity = 0.5 + (scaleFactor - 0.7) * 1.5; // Min 0.5, Max 1
                    const blur = scaleFactor < 0.9 ? 'blur(2px)' : 'none';
                    
                    // Z-index: Quan tr·ªçng ƒë·ªÉ x·∫øp l·ªõp ƒë√® l√™n/xu·ªëng d∆∞·ªõi bao l√¨ x√¨
                    // Gi·∫£ s·ª≠ bao l√¨ x√¨ z-index = 20.
                    const zIndex = Math.floor(scaleFactor * 20); 

                    // L∆∞u dataset ƒë·ªÉ d√πng khi click
                    sat.el.dataset.x = x; 
                    sat.el.dataset.y = y;

                    sat.el.style.transform = `translate(${x}px, ${y}px) scale(${scaleFactor})`;
                    sat.el.style.zIndex = zIndex;
                    sat.el.style.opacity = opacity;
                    sat.el.style.filter = blur;
                    // B√≥ng ƒë·ªï c≈©ng thay ƒë·ªïi theo kho·∫£ng c√°ch
                    sat.el.style.boxShadow = `0 0 ${15 * scaleFactor}px rgba(255, 215, 0, ${scaleFactor - 0.5})`;
                });

                requestAnimationFrame(animateSatellites);
            }

            requestAnimationFrame(animateSatellites);
            setTimeout(() => satellites.forEach(s => s.el.style.transition = 'opacity 1s'), 100); // Fade in
            setInterval(() => spawnManyFireworks(Math.random()*(isMobile?2:3) + 1), 3000);
        }

        /* --- 4. X·ª¨ L√ù L√å X√å --- */
        const envelope = document.getElementById('final-envelope');
        const modal = document.getElementById('red-envelope-screen');
        const openSound = document.getElementById('open-sound');
        const burstSound = document.getElementById('burst-sound');
        let dustInterval;

        envelope.addEventListener('click', () => {
            if(envelope.classList.contains('open')) return;
            envelope.classList.add('open');
            openSound.play().catch(()=>{});

            setTimeout(() => {
                burstSound.play().catch(()=>{});
                const coinCount = isMobile ? 30 : 60;
                const confettiCount = isMobile ? 50 : 100;
                
                spawnSpecificBurst(window.innerWidth/2, window.innerHeight/2, coinCount, ['#FFD700', '#FFA500'], 'coin');
                spawnSpecificBurst(window.innerWidth/2, window.innerHeight/2, confettiCount, ['#FF0000', '#FFFF00', '#FF4500'], 'confetti');

                setTimeout(() => {
                    modal.style.display = 'flex';
                    dustInterval = setInterval(createGoldDust, 200);
                }, 400);
            }, 600);
        });

        function closeModal() {
            modal.style.display = 'none';
            clearInterval(dustInterval);
            envelope.classList.remove('open');
        }

        /* --- FIREWORKS ENGINE --- */
        function spawnManyFireworks(n) {
            for(let i=0; i<n; i++) {
                setTimeout(() => {
                    spawnFireworkBurst(
                        Math.random() * window.innerWidth, Math.random() * window.innerHeight * 0.7,
                        Math.random() * 15 + 15, ['#FF0000', '#FFD700', '#00FF00', '#00FFFF', '#FF00FF']
                    );
                }, Math.random() * 800);
            }
        }
        function spawnFireworkBurst(x, y, count, colors) {
            for(let i=0; i<count; i++) createParticle(x, y, colors);
        }
        function createParticle(x, y, colors) {
            const p = document.createElement('div'); p.className = 'burst-particle';
            globalParticles.appendChild(p);
            const color = colors[Math.floor(Math.random()*colors.length)];
            const size = Math.random()*(isMobile?3:4) + 2; 
            const angle = Math.random() * Math.PI * 2;
            const vel = Math.random() * 100 + 50; 
            const tx = Math.cos(angle) * vel;
            const ty = Math.sin(angle) * vel + 100;
            p.style.left = x+'px'; p.style.top = y+'px';
            p.style.width = size+'px'; p.style.height = size+'px';
            p.style.background = color; p.style.boxShadow = `0 0 ${size}px ${color}`;
            p.animate([{transform:'translate(0,0) scale(1)', opacity:1}, {transform:`translate(${tx}px, ${ty}px) scale(0)`, opacity:0}], {duration: Math.random()*800+600, easing:'cubic-bezier(0.25,1,0.5,1)'}).onfinish = () => p.remove();
        }
        function spawnSpecificBurst(x, y, count, colors, type) {
            for(let i=0; i<count; i++) {
                const p = document.createElement('div'); p.className = 'burst-particle';
                globalParticles.appendChild(p);
                const color = colors[Math.floor(Math.random()*colors.length)];
                const size = Math.random()*6 + 3;
                const angle = Math.random() * Math.PI * 2;
                const vel = Math.random() * 200 + 80;
                const tx = Math.cos(angle) * vel;
                const ty = Math.sin(angle) * vel + 250;
                p.style.left = x+'px'; p.style.top = y+'px';
                p.style.width = size+'px'; p.style.height = (type==='coin'?size:size*1.5)+'px';
                p.style.background = color;
                if(type==='coin'){ p.style.borderRadius='50%'; p.style.border='1px solid gold'; } else { p.style.borderRadius='0'; }
                p.animate([{transform:'translate(0,0) rotate(0deg)', opacity:1}, {transform:`translate(${tx}px, ${ty}px) rotate(${Math.random()*360}deg)`, opacity:0}], {duration: Math.random()*1200+800, easing:'ease-out'}).onfinish = () => p.remove();
            }
        }
        function createGoldDust() {
            const d = document.createElement('div'); d.className='gold-dust';
            d.style.left = Math.random()*100+'%'; d.style.top='-10px';
            document.getElementById('modal-particles').appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }

        /* --- AUDIO --- */
        const musicBtn = document.getElementById('music-toggle');
        const bgMusic = document.getElementById('bg-music');
        let playing = false;
        document.body.addEventListener('click', () => { if(!playing) { bgMusic.play(); playing=true; musicBtn.style.animation='spin 5s linear infinite'; } }, {once:true});
        musicBtn.addEventListener('click', (e) => { e.stopPropagation(); if(playing){ bgMusic.pause(); musicBtn.style.animation='none'; } else { bgMusic.play(); musicBtn.style.animation='spin 5s linear infinite'; } playing = !playing; });
    </script>
</body>
</html>